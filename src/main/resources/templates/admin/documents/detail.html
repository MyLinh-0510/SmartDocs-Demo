<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title th:text="${doc.title}">Chi ti·∫øt t√†i li·ªáu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Th∆∞ vi·ªán ƒë·ªçc Word + Excel -->
    <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            padding: 30px;
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 { text-align: center; margin-bottom: 25px; }

        iframe, img {
            width: 100%;
            height: 600px;
            border: none;
            margin-top: 20px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            margin: 10px;
        }

        .btn-back { background-color: #6c757d; color: white; }
        .btn-download { background-color: #17a2b8; color: white; }

        #previewArea {
            display: none;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background-color: #fafafa;
            max-height: 600px;
            overflow-y: auto;
        }

        #previewError {
            display: none;
            color: red;
            font-weight: 600;
            text-align: center;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 th:text="${doc.title}">Chi ti·∫øt t√†i li·ªáu</h1>

    <div class="info">
        <p><strong>M√¥ t·∫£:</strong> <span th:text="${doc.description}">Kh√¥ng c√≥ m√¥ t·∫£</span></p>
        <p><strong>Lo·∫°i file:</strong> <span th:text="${doc.fileType != null ? doc.fileType.name : 'Kh√¥ng r√µ'}"></span></p>
        <p><strong>Dung l∆∞·ª£ng:</strong>
            <span th:text="|${#numbers.formatDecimal(doc.size / 1024.0 / 1024.0, 1, 2)} MB|"></span>
        </p>
        <p><strong>Ng√†y t·∫°o:</strong> <span th:text="${#temporals.format(doc.createdAt, 'dd/MM/yyyy HH:mm')}"></span></p>
        <p><strong>Tr·∫°ng th√°i:</strong>
            <span th:text="${doc.isVisible ? 'C√¥ng khai' : 'Ri√™ng t∆∞'}"></span>
        </p>
    </div>

    <div class="preview">
        <h3>Xem tr∆∞·ªõc t√†i li·ªáu</h3>

        <!-- üñº H√¨nh ·∫£nh -->
        <img th:if="${#strings.startsWith(doc.mimeType, 'image/')}"
             th:src="@{'/uploads/' + ${doc.filename}}"
             alt="Preview"/>

        <!-- üìÑ PDF -->
        <iframe th:if="${#strings.equals(doc.mimeType, 'application/pdf')}"
                th:src="@{'/uploads/' + ${doc.filename}}"></iframe>

        <!-- üß© Word & Excel -->
        <div th:if="${#strings.containsIgnoreCase(doc.mimeType, 'word')
                     or #strings.containsIgnoreCase(doc.mimeType, 'excel')}">

            <div id="loadingMsg">‚è≥ ƒêang t·∫£i b·∫£n xem tr∆∞·ªõc...</div>
            <div id="previewArea"></div>
            <div id="previewError">‚ùå Kh√¥ng th·ªÉ xem tr∆∞·ªõc. Vui l√≤ng t·∫£i v·ªÅ.</div>

            <script th:inline="javascript">
                const baseUrl = /*[[${publicBaseUrl}]]*/ '';
                const filename = /*[[${encodedFilename}]]*/ '';
                const fileUrl = baseUrl + '/uploads/' + filename;
                const mimeType = /*[[${doc.mimeType}]]*/ '';

                const previewArea = document.getElementById("previewArea");
                const errorDiv = document.getElementById("previewError");
                const loadingMsg = document.getElementById("loadingMsg");

                fetch(fileUrl)
                    .then(resp => {
                        if (!resp.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c file");
                        return resp.arrayBuffer();
                    })
                    .then(buffer => {
                        loadingMsg.style.display = "none";

                        if (mimeType.includes("word")) {
                            mammoth.convertToHtml({ arrayBuffer: buffer })
                                .then(res => {
                                    previewArea.innerHTML = res.value;
                                    previewArea.style.display = "block";
                                })
                                .catch(() => errorDiv.style.display = "block");
                        } else if (mimeType.includes("excel")) {
                            const workbook = XLSX.read(buffer, { type: "array" });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            previewArea.innerHTML = XLSX.utils.sheet_to_html(sheet);
                            previewArea.style.display = "block";
                        } else {
                            errorDiv.style.display = "block";
                        }
                    })
                    .catch(() => {
                        loadingMsg.style.display = "none";
                        errorDiv.style.display = "block";
                    });
            </script>

            <!-- üîó Fallback: Office Viewer n·∫øu kh√¥ng render ƒë∆∞·ª£c -->
            <iframe id="officeFrame" style="display:none; width:100%; height:600px; border:none;"
                    frameborder="0"></iframe>

            <script>
                // N·∫øu previewError hi·ªÉn th·ªã, fallback sang Office viewer
                const observer = new MutationObserver(() => {
                    if (errorDiv.style.display === "block") {
                        const viewerUrl = "https://view.officeapps.live.com/op/embed.aspx?src=" + encodeURIComponent(fileUrl);
                        const officeFrame = document.getElementById("officeFrame");
                        officeFrame.src = viewerUrl;
                        officeFrame.style.display = "block";
                        observer.disconnect();
                    }
                });
                observer.observe(errorDiv, { attributes: true, attributeFilter: ['style'] });
            </script>
        </div>
    </div>

    <div style="margin-top: 30px; text-align: center;">
        <a th:href="@{/admin/documents/index}" class="btn btn-back">‚¨Ö Quay l·∫°i</a>
        <a th:href="@{'/uploads/' + ${doc.filename}}" target="_blank" class="btn btn-download">‚¨á T·∫£i file</a>
    </div>
</div>

</body>
</html>
